<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>汽车保养日志</title>
    <style>/* 简单的样式 */ body{font-family: sans-serif; max-width: 800px; margin: 20px auto; padding: 15px; line-height: 1.6;} h1, h2{text-align: center;} form, .card {border: 1px solid #ccc; padding: 20px; border-radius: 8px; margin-bottom: 20px;} label {display: block; margin-bottom: 5px;} input, button {width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box;} button {background-color: #007bff; color: white; border: none; cursor: pointer;} .items-group {display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px;} .items-group label {display: flex; align-items: center;} .items-group input {width: auto; margin-right: 5px;} #message {text-align: center; font-weight: bold;} table{width:100%; border-collapse: collapse;} th, td{border: 1px solid #ddd; padding: 8px; text-align: left;}</style>
</head>
<body>
    <h1>汽车保养日志</h1>
    <a href="/query.html">前往查询保养建议 &rarr;</a>

        <div class="card">
        <h2>设置购车日期</h2>
        <form id="purchaseDateForm">
            <label for="purchaseDate">购车日期:</label>
            <input type="date" id="purchaseDate" required>
            <button type="submit" id="savePurchaseDateBtn">保存购车日期</button>
        </form>
        <div id="purchaseDateMessage"></div>
    </div>

    <div class="card">
        <h2>记录新的保养</h2>
        <form id="logForm">
            <label for="maintenanceDate">保养日期:</label>
            <input type="date" id="maintenanceDate" required>

            <label for="mileage">保养时里程 (km):</label>
            <input type="number" id="mileage" placeholder="例如: 50000" required>

            <label>保养项目 (可多选):</label>
            <div class="items-group">
                <label><input type="checkbox" name="item" value="机油"> 机油</label>
                <label><input type="checkbox" name="item" value="空气滤芯"> 空气滤芯</label>
                <label><input type="checkbox" name="item" value="火花塞"> 火花塞</label>
                <label><input type="checkbox" name="item" value="冷却液"> 冷却液</label>
                <label><input type="checkbox" name="item" value="制动液"> 制动液</label>
                <label><input type="checkbox" name="item" value="活性炭罐过滤器"> 活性炭罐过滤器</label>
                <label><input type="checkbox" name="item" value="传动皮带"> 传动皮带</label>
                <label><input type="checkbox" name="item" value="节流阀"> 节流阀</label>
                <label><input type="checkbox" name="item" value="四轮对换"> 四轮对换</label>
            </div>

            <button type="submit">提交记录</button>
        </form>
        <div id="message"></div>
    </div>

    <div class="card">
        <h2>历史保养记录</h2>
        <table id="logsTable">
            <thead><tr><th>日期</th><th>里程(km)</th><th>项目</th><th>操作</th></tr></thead>
            <tbody><!-- 记录将在这里动态加载 --></tbody>
        </table>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const logForm = document.getElementById('logForm');
            const messageDiv = document.getElementById('message');
            const purchaseDateForm = document.getElementById('purchaseDateForm');
            const purchaseDateInput = document.getElementById('purchaseDate');
            const savePurchaseDateBtn = document.getElementById('savePurchaseDateBtn');
            const purchaseDateMessage = document.getElementById('purchaseDateMessage');

            // 检查并设置购车日期
            const savedPurchaseDate = localStorage.getItem('carPurchaseDate');
            if (savedPurchaseDate) {
                purchaseDateInput.value = savedPurchaseDate;
                purchaseDateInput.disabled = true;
                savePurchaseDateBtn.disabled = true;
                purchaseDateMessage.textContent = `购车日期已设置为: ${savedPurchaseDate}。如需修改，请联系管理员。`;
                purchaseDateMessage.style.color = 'green';
            }
            
            // 加载历史记录
            loadHistory();

            // 保存购车日期事件
            purchaseDateForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const purchaseDate = purchaseDateInput.value;
                if (!purchaseDate) {
                    purchaseDateMessage.textContent = '请选择一个日期。';
                    purchaseDateMessage.style.color = 'red';
                    return;
                }

                try {
                    const response = await fetch('/api/log', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ purchase_date: purchaseDate })
                    });
                    const result = await response.json();

                    if (response.ok) {
                        localStorage.setItem('carPurchaseDate', purchaseDate);
                        purchaseDateInput.disabled = true;
                        savePurchaseDateBtn.disabled = true;
                        purchaseDateMessage.textContent = `购车日期已成功保存为: ${purchaseDate}`;
                        purchaseDateMessage.style.color = 'green';
                        loadHistory(); // 重新加载以显示“车辆购买”记录
                    } else {
                        throw new Error(result.message || '保存失败');
                    }
                } catch (error) {
                    purchaseDateMessage.textContent = '错误: ' + error.message;
                    purchaseDateMessage.style.color = 'red';
                }
            });

            // 提交保养记录事件
            logForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                if (!localStorage.getItem('carPurchaseDate')) {
                    messageDiv.textContent = '请先设置并保存购车日期！';
                    messageDiv.style.color = 'red';
                    return;
                }

                messageDiv.textContent = '提交中...';

                const selectedItems = Array.from(document.querySelectorAll('input[name="item"]:checked')).map(el => el.value);
                if (selectedItems.length === 0) {
                    messageDiv.textContent = '请至少选择一个保养项目！';
                    messageDiv.style.color = 'red';
                    return;
                }

                const data = {
                    maintenance_date: document.getElementById('maintenanceDate').value,
                    mileage: parseInt(document.getElementById('mileage').value),
                    items: selectedItems
                };

                try {
                    const response = await fetch('/api/log', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    const result = await response.json();

                    if (response.ok) {
                        messageDiv.textContent = result.message;
                        messageDiv.style.color = 'green';
                        logForm.reset();
                        loadHistory(); // 重新加载历史
                    } else {
                        throw new Error(result.message || '提交失败');
                    }
                } catch (error) {
                    messageDiv.textContent = '错误: ' + error.message;
                    messageDiv.style.color = 'red';
                }
            });
        });
        
        // 统一的事件委托，处理所有删除按钮的点击
            document.getElementById('logsTable').addEventListener('click', (e) => {
                // 检查被点击的元素是否是删除按钮
                if (e.target && e.target.matches('button.delete-btn')) {
                    const id = e.target.getAttribute('data-id');
                    if (id) {
                        deleteLog(id);
                    }
                }
            });
        });
        
        async function loadHistory() {
            const tableBody = document.querySelector('#logsTable tbody');
            tableBody.innerHTML = '<tr><td colspan="4">加载中...</td></tr>';
            try {
                const response = await fetch('/api/maintenance');
                const logs = await response.json();
                if(response.ok) {
                    if (logs.length > 0) {
                        tableBody.innerHTML = logs.map(log => `
                            <tr id="log-${log.id}">
                                <td>${log.maintenance_date}</td>
                                <td>${log.mileage}</td>
                                <td>${log.item_name}</td>
                                <td>
                                    ${log.item_name !== '车辆购买' ? `<button class="delete-btn" data-id="${log.id}">删除</button>` : ''}
                                </td>
                            </tr>
                        `).join('');
                    } else {
                         tableBody.innerHTML = '<tr><td colspan="4">暂无记录。</td></tr>';
                    }
                } else {
                     throw new Error(logs.error);
                }
            } catch(error) {
                tableBody.innerHTML = `<tr><td colspan="4">加载历史记录失败: ${error.message}</td></tr>`;
            }
        }

        async function deleteLog(id) {
            if (!confirm('确定要删除这条记录吗？')) {
                return;
            }
            try {
                const response = await fetch(`/api/maintenance?id=${id}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (response.ok) {
                    alert(result.message);
                    loadHistory(); // 重新加载
                } else {
                    throw new Error(result.error || '删除失败');
                }
            } catch (error) {
                alert('删除时发生错误: ' + error.message);
            }
        }

        async function deleteLog(id) {
            if (!confirm('确定要删除这条记录吗？')) {
                return;
            }
            try {
                const response = await fetch(`/api/log?id=${id}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (response.ok) {
                    alert(result.message);
                    loadHistory(); // 重新加载
                } else {
                    throw new Error(result.error || '删除失败');
                }
            } catch (error) {
                alert('删除时发生错误: ' + error.message);
            }
        }
    </script>
</body>
</html>